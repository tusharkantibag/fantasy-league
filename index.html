<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Fever IPL Fantasy 2026 — v4.8.0 (XI Budget)</title>

  <!-- Correct CSS/Icons includes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <style>
   ity) --- */
    body { background:#f5f7fb; }
    nav .brand-logo { font-weight:800; }
    .tabs .tab a { color:#1976d2; }
    .tabs .tab a.active { color:#0d47a1; }
    .tabs .indicator { background-color:#1976d2; }
    .player-list { display:flex; flex-direction:column; gap:10px; max-height:70vh; overflow:auto; }
    .player-card { background:#fff; border-radius:12px; padding:10px; display:flex; align-items:center; gap:12px; border:1px solid #e3e6ea; }
    .avatar { width:48px; height:48px; border-radius:8px; object-fit:cover; border:1px solid #e0e0e0; background:#fafafa; flex:0 0 auto; }
    .player-info { flex:1; display:flex; flex-direction:column; }
    .player-name { font-weight:600; font-size:.98rem; }
    .player-meta { font-size:.83rem; color:#546e7a; display:flex; gap:.5rem; align-items:center; }
    .role-chip { font-size:.72rem; padding:.1rem .45rem; border-radius:12px; background:#eceff1; color:#263238; margin-left:.4rem; }
    .team-chip { font-size:.7rem; padding:.08rem .4rem; border-radius:10px; background:#e3f2fd; color:#0d47a1; }
    .sticky-actions { position: sticky; bottom: 0; background:#fff; padding:.75rem; border-top:1px solid #eee; display:flex; gap:.75rem; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .budget { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
    .badge-inline { display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .6rem; border-radius:14px; background:#eceff1; color:#263238; font-size:.85rem; }
    .badge-inline .material-icons { font-size:18px; }
    .badge-ok { background:#e8f5e9; color:#1b5e20; }
    .badge-warn { background:#fff8e1; color:#e65100; }
    .badge-alert { background:#ffebee; color:#b71c1c; }
    .cap-line { font-size:.9rem; color:#37474f; margin:.25rem 0; }
    .pill { display:inline-flex; align-items:center; gap:.3rem; padding:.18rem .5rem; border-radius:12px; background:#eceff1; font-size:.78rem; color:#37474f; }
    .preview-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; margin-top:.6rem; }
    .square-card { background:#fafcff; border:1px solid #dde5ee; border-radius:12px; padding:10px; display:flex; flex-direction:column; align-items:center; position:relative; }
    .square-card .pic { width:100%; aspect-ratio:1/1; border-radius:10px; overflow:hidden; background:#fff; border:1px solid #e0e0e0; display:flex; align-items:center; justify-content:center; }
    .square-card .pic img { width:100%; height:100%; object-fit:cover; }
    .square-card .name { margin-top:.5rem; font-weight:700; font-size:.95rem; text-align:center; }
    .square-card .team { font-size:.8rem; color:#607d8b; text-align:center; margin-top:.15rem; }
    .square-card .role { font-size:.78rem; text-align:center; margin-top:.2rem; padding:.12rem .5rem; border-radius:12px; background:#eceff1; color:#37474f; display:inline-block; }
    .square-card .remove { position:absolute; top:8px; right:8px; }
  </style>
</head>
<body>
  <nav class="blue">
    <div class="nav-wrapper container">
      <a href="#submit" class="brand-logo"><i class="material-icons">emoji_events</i> Sports Fever IPL Fantasy 2026</a>
    </div>
  </nav>

  <main class="container" style="margin-top:1.25rem;">
    <div class="row"><div class="col s12">
      <ul class="tabs">
        <li class="tab col s3"><a href="#submit" class="active"><i class="material-icons left">swap_horiz</i>Transfers</a></li>
        <li class="tab col s3"><a href="#leaderboard"><i class="material-icons left">leaderboard</i>Leaderboard</a></li>
      </ul>
    </div></div>

    <section id="submit" class="col s12">
      <div class="row">
        <div class="col s12 l5">
          <div class="card"><div class="card-content">
            <span class="card-title">Manage Transfers <span class="new badge blue" id="selCount" data-badge-caption="/11 selected">0</span></span>

            <div class="row">
              <div class="input-field col s12 m6">
                <input id="email" type="email" class="validate" placeholder="you@example.com">
                <label class="active" for="email">Your Email</label>
              </div>
              <div class="input-field col s12 m6">
                <select id="matchSelect"></select>
                <label>For Match</label>
              </div>
            </div>

            <div class="budget" id="budgetPanel" style="margin-bottom:.25rem;">
              <span class="badge-inline"><i class="material-icons">sync_alt</i> Today: <b id="todayChanges">0</b> transfers</span>
              <span class="badge-inline"><i class="material-icons">timelapse</i> Used: <b id="usedSoFar">0</b></span>
              <span class="badge-inline"><i class="material-icons">battery_std</i> Remaining: <b id="remaining">100</b></span>
              <span class="badge-inline"><i class="material-icons">flag</i> Budget: <b id="budget">100</b></span>
              <span class="badge-inline" id="xiCostBadge"><i class="material-icons">attach_money</i> XI Cost: <b id="xiTotal">0</b> / <b id="xiCap">—</b></span>
            </div>

            <div id="capLine" class="cap-line">Team cap: max — per team.</div>

            <div class="filters" style="margin-top:.5rem;">
              <span class="filter-chip"><i class="material-icons">groups</i>
                <select id="teamFilter"><option value="ALL" selected>All teams</option></select>
              </span>
              <span class="filter-chip"><i class="material-icons">person</i>
                <select id="roleFilter">
                  <option value="ALL" selected>All roles</option>
                  <option value="WK">WK</option><option value="BAT">BAT</option><option value="AR">AR</option><option value="BOWL">BOWL</option>
                </select>
              </span>
              <div class="input-field" style="margin:0; max-width:260px;">
                <i class="material-icons prefix">search</i>
                <input id="searchInput" type="text" placeholder="Search player..." />
              </div>
            </div>

            <div id="playersList" class="player-list"></div>
            <p class="helper">Tip: If this is your first time, pick 11 players and click <b>Build First XI</b>. From tomorrow you’ll just submit transfers.</p>
            <div class="health" id="healthLine" style="display:none;"></div>
          </div>

          <div class="sticky-actions">
            <a id="refreshPlayers" class="btn-flat waves-effect"><i class="material-icons left">refresh</i>Reload</a>
            <a id="submitBtn" class="btn waves-effect waves-light blue disabled"><i class="material-icons left">swap_horiz</i>Submit Transfers</a>
            <a id="buildFirstBtn" class="btn waves-effect green darken-1 disabled" style="display:none;"><i class="material-icons left">playlist_add_check</i>Build First XI</a>
          </div></div>
        </div>

        <div class="col s12 l7">
          <div class="card preview-card"><div class="card-content">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <span class="card-title">My XI Preview</span>
              <a id="clearAll" class="btn-flat"><i class="material-icons left">backspace</i>Clear All</a>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:.5rem; margin:.25rem 0 .5rem 0;">
              <span class="pill" id="pillWK">WK: 0</span>
              <span class="pill" id="pillBAT">BAT: 0</span>
              <span class="pill" id="pillAR">AR: 0</span>
              <span class="pill" id="pillBOWL">BOWL: 0</span>
              <span class="pill" id="pillTeams">Teams: —</span>
            </div>
            <div id="previewGrid" class="preview-grid"></div>
            <div id="validationMsg" class="helper" style="margin-top:.6rem;"></div>
          </div></div>
        </div>
      </div>
    </section>

    <section id="leaderboard" class="col s12">
      <div class="card"><div class="card-content">
        <span class="card-title">Leaderboard <a id="refreshLb" class="btn-flat right"><i class="material-icons">autorenew</i></a></span>
        <table class="striped highlight responsive-table"><thead><tr><th>#</th><th>User</th><th>Points</th></tr></thead><tbody id="lbTable"><tr><td colspan="3">Loading…</td></tr></tbody></table>
      </div></div>
    </section>

    <!-- Confirm modal -->
    <div id="confirmModal" class="modal" style="overflow:visible;">
      <div class="modal-content" style="position:relative;">
        <h5 id="confirmTitle">Confirm Transfers</h5>
        <div id="confirmSummary" style="margin:.5rem 0 1rem 0;"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div><div class="pill" style="background:#ef9a9a;border:1px solid #b71c1c;color:#7f0000;"><i class="material-icons">remove</i> Players OUT</div><ul id="listDrops" class="collection" style="margin-top:.5rem;"></ul></div>
          <div><div class="pill" style="background:#a5d6a7;border:1px solid #1b5e20;color:#0a3d14;"><i class="material-icons">add</i> Players IN</div><ul id="listAdds" class="collection" style="margin-top:.5rem;"></ul></div>
        </div>
        <div id="ruleWarnings" class="red-text" style="margin-top:12px;display:none;"></div>
        <div id="capWarnings" class="red-text" style="margin-top:4px;display:none;"></div>
      </div>
      <div class="modal-footer">
        <a id="confirmSubmitBtn" href="#" class="btn waves-effect blue"><i class="material-icons left">check</i><span id="confirmSubmitLabel">Confirm & Submit</span></a>
        <a href="#" class="modal-close btn-flat"><i class="material-icons left">close</i>Cancel</a>
      </div>
    </div>
  </main>

  <!-- Correct JS include -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
  // Read ?api=https://script.google.com/macros/s/AKfycbyMOWIgJ2vK3t8DFdfttOK0-rjcbOZl0WzhDNFg3hHTrBul0xUPBCB0XILsV49aPlMP/exec';

  function notify(msg){ M.toast({html: msg, displayLength: 3500}); }
  function formatRole(r){ if(!r) return ''; r=String(r).trim().toUpperCase(); if(r==='WICKETKEEPER') return 'WK'; if(r==='BATSMAN'||r==='BATTER') return 'BAT'; if(r==='ALL-ROUNDER'||r==='ALLROUNDER'||r==='ALL_ROUNDER') return 'AR'; if(r==='BOWLER') return 'BOWL'; return r; }

  const emailEl=document.getElementById('email');
  const matchSelectEl=document.getElementById('matchSelect');
  const selCount=document.getElementById('selCount');
  const playersList=document.getElementById('playersList');
  const teamFilter=document.getElementById('teamFilter');
  const roleFilter=document.getElementById('roleFilter');
  const searchInput=document.getElementById('searchInput');
  const submitBtn=document.getElementById('submitBtn');
  const buildFirstBtn=document.getElementById('buildFirstBtn');
  const capLine=document.getElementById('capLine');
  const healthLine=document.getElementById('healthLine');
  const pillWK=document.getElementById('pillWK');
  const pillBAT=document.getElementById('pillBAT');
  const pillAR=document.getElementById('pillAR');
  const pillBOWL=document.getElementById('pillBOWL');
  const pillTeams=document.getElementById('pillTeams');
  const previewGrid=document.getElementById('previewGrid');
  const clearAllBtn=document.getElementById('clearAll');
  const lbTable=document.getElementById('lbTable');
  const xiCapEl=document.getElementById('xiCap');
  const xiTotalEl=document.getElementById('xiTotal');
  const xiCostBadge=document.getElementById('xiCostBadge');

  let allPlayers=[]; let lastTeamPlayers=[]; let userBudget=100, userUsed=0, maxFromTeam=7;
  let constraints={WK:{min:1,max:2}, BAT:{min:3,max:6}, AR:{min:1,max:4}, BOWL:{min:3,max:6}};
  let playersReady=false, statsReady=false;
  let xiCap = Infinity;

  if(!urlApi && API.startsWith('PUT_')){
    setTimeout(()=>notify('API not configured: add ?api=<Your Apps Script Web App URL> to this page URL'), 700);
  }

  function selected(){ return Array.from(document.querySelectorAll('#playersList input[type=checkbox]:checked')).map(x=>x.value); }
  function countChanges(prev, curr){ const s=new Set(prev||[]); let overlap=0; (curr||[]).forEach(p=>{ if(s.has(p)) overlap++; }); return 11-overlap; }
  function teamCountsOf(list){ const c={}; (list||[]).forEach(name=>{ const p=allPlayers.find(x=>x.name===name); const t=String((p&&p.team)||''); if(t) c[t]=(c[t]||0)+1; }); return c; }
  function capStatus(list){ const c=teamCountsOf(list); const over = Object.keys(c).filter(t=>c[t]>maxFromTeam); return {counts:c, overTeams:over}; }
  function roleCounts(list){ const c={WK:0,BAT:0,AR:0,BOWL:0}; (list||[]).forEach(name=>{ const p=allPlayers.find(x=>x.name===name); const r=formatRole((p&&p.role)||''); if(c[r]!==undefined) c[r]++; }); return c; }
  function xiTotalOf(names){ let sum=0; (names||[]).forEach(n=>{ const p=allPlayers.find(x=>x.name===n); sum+=Number((p&&p.price)||0); }); return sum; }

  function refreshRuleChips(){
    const row=document.getElementById('roleRulesRow')||document.createElement('div');
    row.style.display='flex';
    const counts=roleCounts(selected());
    const setChip=(id,key,label)=>{
      const el=document.getElementById(id), v=constraints[key]||{min:0,max:0}, n=counts[key]||0;
      el.classList.remove('ok','bad');
      el.textContent=`${label}: ${n} (min ${v.min}, max ${v.max})`;
      const old=M.Tooltip.getInstance(el); if(old) old.destroy();
      el.setAttribute('data-tooltip', n<v.min?`Need ${v.min-n} more ${label}`: n>v.max?`Too many ${label}: reduce by ${n-v.max}`:`Within range`);
      M.Tooltip.init(el,{position:'top',margin:6});
      if(n<v.min || n>v.max) el.classList.add('bad'); else el.classList.add('ok');
    };
    setChip('ruleWK','WK','WK'); setChip('ruleBAT','BAT','BAT'); setChip('ruleAR','AR','AR'); setChip('ruleBOWL','BOWL','BOWL');
  }

  function renderPreview(){
    const names=selected();
    const rc=roleCounts(names);
    pillWK.textContent=`WK: ${rc.WK}`; pillBAT.textContent=`BAT: ${rc.BAT}`; pillAR.textContent=`AR: ${rc.AR}`; pillBOWL.textContent=`BOWL: ${rc.BOWL}`;
    const tc=teamCountsOf(names);
    const teamsStr=Object.keys(tc).length? Object.keys(tc).sort().map(t=>`${t} ${tc[t]}`).join(' • ') : '—';
    pillTeams.textContent = `Teams: ${teamsStr}`;
    previewGrid.innerHTML='';
    if(!names.length){ previewGrid.innerHTML='<span class="helper">No players selected yet.</span>'; refreshRuleChips(); return; }

    names.forEach(n=>{
      const p=allPlayers.find(x=>x.name===n) || {name:n, team:'', role:'', imageUrl:''};
      const role=formatRole(p.role||'');
      const card=document.createElement('div'); card.className='square-card';
      const pic=document.createElement('div'); pic.className='pic';
      if(p.imageUrl){ const img=document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.referrerPolicy='no-referrer'; img.src=p.imageUrl; img.onerror=function(){ this.remove(); pic.innerHTML='<i class="material-icons">person</i>'; }; pic.appendChild(img); }
      else { pic.innerHTML='<i class="material-icons">person</i>'; }
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=p.name;
      const tm=document.createElement('div'); tm.className='team'; tm.textContent=p.team||'';
      const rl=document.createElement('div'); rl.className='role'; rl.textContent=role||'—';
      const btn=document.createElement('a'); btn.href='#'; btn.className='btn-flat remove'; btn.innerHTML='<i class="material-icons">close</i>'; btn.addEventListener('click', e=>{ e.preventDefault(); togglePlayer(p.name,false); });
      card.appendChild(btn); card.appendChild(pic); card.appendChild(nm); card.appendChild(tm); card.appendChild(rl); previewGrid.appendChild(card);
    });

    const msg=document.getElementById('validationMsg');
    const cap=capStatus(names); const withinCap = cap.overTeams.length===0;
    const overXIBudget = isFinite(xiCap) ? (xiTotalOf(names) > xiCap) : false;
    if(!withinCap){ msg.className='helper red-text'; msg.textContent='Team cap exceeded: '+cap.overTeams.join(', '); }
    else if(overXIBudget){ msg.className='helper red-text'; msg.textContent='XI budget exceeded. Please adjust.'; }
    else { msg.className='helper'; msg.textContent='Looks good!'; }
    refreshRuleChips();
  }

  function togglePlayer(name,on){
    const map=new Map(); document.querySelectorAll('#playersList input[type=checkbox]').forEach(cb=>map.set(cb.value, cb));
    if(map.has(name)) map.get(name).checked=!!on;
    updateSelectionUI();
  }

  function updateBadges(chg){
    const names=selected(); const xiTotal=xiTotalOf(names);
    xiTotalEl.textContent=String(xiTotal);
    xiCapEl.textContent=isFinite(xiCap)?String(xiCap):'—';

    const remain=Math.max(0, userBudget-(userUsed+chg));
    document.getElementById('todayChanges').textContent=String(chg);
    document.getElementById('usedSoFar').textContent=String(userUsed+chg);
    document.getElementById('remaining').textContent=String(remain);
    document.getElementById('budget').textContent=String(userBudget);

    const panel=document.getElementById('budgetPanel');
    panel.querySelectorAll('.badge-inline').forEach(b=>b.classList.remove('badge-ok','badge-warn','badge-alert'));
    const color = remain<0 ? 'badge-alert' : (remain<=10 ? 'badge-warn' : 'badge-ok');
    const badges = panel.querySelectorAll('.badge-inline');
    for(let i=0;i<4 && i<badges.length;i++) badges[i].classList.add(color);
    if(isFinite(xiCap)){ xiCostBadge.classList.add(xiTotal>xiCap ? 'badge-alert' : (xiCap-xiTotal<=10 ? 'badge-warn' : 'badge-ok')); }
    else { xiCostBadge.classList.add('badge-ok'); }
  }

  function updateSelectionUI(){
    const names=selected(); const n=names.length;
    selCount.setAttribute('data-badge-caption','/11 selected'); selCount.textContent=n;

    const ch=countChanges(lastTeamPlayers, names);
    updateBadges(ch);
    renderPreview();

    const anyBad = document.querySelectorAll('#roleRulesRow .bad').length>0;
    const cap=capStatus(names); const withinCapPerTeam=cap.overTeams.length===0;
    const hasBase=!!(lastTeamPlayers && lastTeamPlayers.length);
    const overXIBudget=isFinite(xiCap)?(xiTotalOf(names)>xiCap):false;

    submitBtn.style.display = hasBase ? 'inline-flex' : 'none';
    buildFirstBtn.style.display = hasBase ? 'none' : 'inline-flex';

    const invalid = !emailEl.value || !matchSelectEl.value || n!==11 || !withinCapPerTeam || anyBad || overXIBudget;
    if (invalid){ submitBtn.classList.add('disabled'); buildFirstBtn.classList.add('disabled'); }
    else { if(hasBase){ ((userUsed+ch)>userBudget) ? submitBtn.classList.add('disabled') : submitBtn.classList.remove('disabled'); } else { buildFirstBtn.classList.remove('disabled'); } }
  }

  function buildFilters(list){
    const teams=Array.from(new Set(list.map(p=>String(p.team||'').toUpperCase()).filter(Boolean))).sort();
    teamFilter.innerHTML='<option value="ALL" selected>All teams</option>'+teams.map(t=>`<option value="${t}">${t}</option>`).join('');
    M.FormSelect.init(teamFilter); M.FormSelect.init(roleFilter);
  }

  function applyLastXIIfReady(){
    if(!(playersReady && statsReady)) return;
    const map=new Map(); document.querySelectorAll('#playersList input[type=checkbox]').forEach(cb=>map.set(cb.value, cb));
    let checked=0; (lastTeamPlayers||[]).forEach(n=>{ if(map.has(n)&&checked<11){ map.get(n).checked=true; checked++; } });
    updateSelectionUI();
    if(lastTeamPlayers && lastTeamPlayers.length){ document.getElementById('transferBanner').style.display='flex'; }
  }

  function renderPlayers(){
    const t=teamFilter.value||'ALL', r=roleFilter.value||'ALL', q=(searchInput.value||'').trim().toLowerCase();
    const filtered=allPlayers.filter(p=>{
      const tOk=(t==='ALL') || String(p.team||'').toUpperCase()===t;
      const rOk=(r==='ALL') || formatRole(p.role||'')===r;
      const qOk=!q || String(p.name||'').toLowerCase().includes(q);
      return tOk&&rOk&&qOk;
    });
    playersList.innerHTML='';
    filtered.forEach(p=>{
      const card=document.createElement('div'); card.className='player-card';
      const img=document.createElement(p.imageUrl?'img':'i');
      if(p.imageUrl){ img.className='avatar'; img.loading='lazy'; img.decoding='async'; img.referrerPolicy='no-referrer'; img.src=p.imageUrl; img.onerror=function(){ this.remove(); }; }
      else { img.className='material-icons grey-text'; img.textContent='person'; }
      const label=document.createElement('label'); label.innerHTML='<input type="checkbox"/><span></span>'; label.querySelector('input').value=p.name;
      const info=document.createElement('div'); info.className='player-info';
      const roleShort=formatRole(p.role||'')||'—'; const priceChip=`<span class="role-chip" title="Price">${Number(p.price||0)}</span>`;
      info.innerHTML = `<span class="player-name">${p.name}<span class="role-chip">${roleShort}</span>${priceChip}</span><span class="player-meta"><span class="team-chip">${p.team||''}</span></span>`;
      card.appendChild(label); card.appendChild(img); card.appendChild(info); playersList.appendChild(card);
    });
    document.querySelectorAll('#playersList input[type=checkbox]').forEach(cb=>cb.addEventListener('change', updateSelectionUI));
    buildFilters(allPlayers); playersReady=true; applyLastXIIfReady();
  }

  async function fetchMatches(){
    matchSelectEl.innerHTML='<option value="">Loading…</option>';
    try{
      const res=await fetch(`${API}?action=matches`); const j=await res.json();
      if(!j.ok){ notify(j.error||'API error (matches)'); return; }
      const list=Array.isArray(j.matches)? j.matches:[];
      const opts=['<option value="">-- Select Match --</option>']; list.forEach(m=>opts.push(`<option value="${m.id}">${m.label||m.match||('Match '+m.id)}</option>`));
      matchSelectEl.innerHTML=opts.join(''); M.FormSelect.init(matchSelectEl); if(list.length){ matchSelectEl.value=String(list[0].id); M.FormSelect.init(matchSelectEl); }
      healthLine.style.display='block'; healthLine.innerHTML = `<b>Health</b>: matches=${list.length}, players=${allPlayers.length}`;
    }catch(e){ notify('Network error (matches)'); }
  }

  async function fetchAllPlayers(){
    playersList.innerHTML='Loading players…';
    try{
      const res=await fetch(`${API}?action=allplayers`); const j=await res.json();
      if(!j.ok){ playersList.innerHTML=`<span class="red-text">${j.error||'API error'}</span>`; return; }
      allPlayers=Array.isArray(j.players)? j.players: []; renderPlayers();
      if(!allPlayers.length) notify('No players returned. Check Players headers.');
    }catch(e){ playersList.innerHTML='<span class="red-text">Network error</span>'; }
  }

  async function fetchUserStats(){
    const email=(emailEl.value||'').trim().toLowerCase(); if(!email) return;
    try{
      const res=await fetch(`${API}?action=userstats&email=${encodeURIComponent(email)}`); const j=await res.json();
      if(!j.ok){ notify('Stats error'); return; }
      userBudget=Number(j.budget||100); userUsed=Number(j.used||0); lastTeamPlayers=Array.isArray(j.lastTeam)? j.lastTeam: []; maxFromTeam=Number(j.maxFromTeam||7); constraints=j.constraints||constraints;
      xiCap = Number(j.xiBudgetCap); if(!(isFinite(xiCap)&&xiCap>=0)) xiCap=Infinity; xiCapEl.textContent=isFinite(xiCap)?String(xiCap):'—';
      updateBadges(0); capLine.textContent=`Team cap: max ${maxFromTeam} per team.`; statsReady=true; applyLastXIIfReady();
    }catch(e){ notify('Network error (stats)'); }
  }

  async function loadLeaderboard(){
    lbTable.innerHTML='<tr><td colspan="3">Loading…</td></tr>';
    try{
      const res=await fetch(`${API}?action=leaderboard`); const j=await res.json();
      if(!j.ok){ lbTable.innerHTML = `<tr><td colspan="3" class="red-text">${j.error||'API error'}</td></tr>`; return; }
      lbTable.innerHTML = (j.leaderboard||[]).map((r,i)=>`<tr><td>${i+1}</td><td>${r.name||''}</td><td><span class="new badge green" data-badge-caption="">${r.total}</span></td></tr>`).join('')
        || '<tr><td colspan="3" class="grey-text">No data yet.</td></tr>';
    }catch(e){ lbTable.innerHTML='<tr><td colspan="3" class="red-text">Failed</td></tr>'; }
  }

  function computeTransfers(){ const prev=new Set(lastTeamPlayers||[]), curr=new Set(selected()||[]); return { adds:Array.from(curr).filter(x=>!prev.has(x)), drops:Array.from(prev).filter(x=>!curr.has(x)) }; }

  async function submitTransfers(){
    const email=(emailEl.value||'').trim(); const names=selected();
    if(!email||!matchSelectEl.value){ notify('Email & Match required'); return; }
    if(!lastTeamPlayers || !lastTeamPlayers.length){ notify('No previous XI found; build your first XI.'); return; }
    if(names.length!==11){ notify('Your XI must have exactly 11 after transfers'); return; }
    submitBtn.classList.add('disabled');
    try{
      const {adds,drops}=computeTransfers();
      const qs=new URLSearchParams(); qs.set('action','submittransfers'); qs.set('email',email); qs.set('matchId',matchSelectEl.value); qs.set('adds',JSON.stringify(adds)); qs.set('drops',JSON.stringify(drops));
      const res=await fetch(`${API}?${qs.toString()}`,{method:'GET'}); const j=await res.json();
      if(j.ok){ notify(`Transfers applied: +${adds.length}/-${drops.length}`); await fetchUserStats(); lastTeamPlayers=names.slice(); updateSelectionUI(); }
      else { notify(j.error||'Failed to apply transfers'); }
    }catch(e){ notify('Network error'); }
    finally{ submitBtn.classList.remove('disabled'); }
  }

  async function buildFirstXI(){
    const email=(emailEl.value||'').trim(); const names=selected();
    if(!email||!matchSelectEl.value){ notify('Email & Match required'); return; }
    if(names.length!==11){ notify('Pick exactly 11 to build your first XI'); return; }
    buildFirstBtn.classList.add('disabled');
    try{
      const qs=new URLSearchParams(); qs.set('action','submitteam'); qs.set('email',email); qs.set('matchId',matchSelectEl.value); qs.set('players', JSON.stringify(names));
      const res=await fetch(`${API}?${qs.toString()}`,{method:'GET'}); const j=await res.json();
      if(j.ok){ notify('First XI saved! Now you can do transfers.'); await fetchUserStats(); lastTeamPlayers=names.slice(); updateSelectionUI(); }
      else { notify(j.error||'Failed to build first XI'); }
    }catch(e){ notify('Network error'); }
    finally{ buildFirstBtn.classList.remove('disabled'); }
  }

  function openConfirmModal(mode='transfers'){
    const names=selected();
    const titleEl=document.getElementById('confirmTitle');
    const summaryEl=document.getElementById('confirmSummary');
    const listAdds=document.getElementById('listAdds');
    const listDrops=document.getElementById('listDrops');
    const confirmBtn=document.getElementById('confirmSubmitBtn');
    const confirmLabel=document.getElementById('confirmSubmitLabel');

    let adds=[],drops=[],cost=0;
    if(mode==='firstxi'){ adds=names.slice(); drops=[]; cost=0; titleEl.textContent='Confirm First XI'; confirmLabel.textContent='Confirm & Save XI'; }
    else { const diff=computeTransfers(); adds=diff.adds; drops=diff.drops; cost=adds.length; titleEl.textContent='Confirm Transfers'; confirmLabel.textContent=`Confirm & Submit (${cost} transfer${cost===1?'':'s'})`; }

    const xiTotalNow=xiTotalOf(names); const xiCapText=isFinite(xiCap)?xiCap:'—';
    summaryEl.innerHTML = `<div class="pill"><i class="material-icons">attach_money</i> XI Cost: ${xiTotalNow} / ${xiCapText}</div>`;

    const renderList=(el,names,kind)=>{ el.innerHTML=''; if(!names.length){ el.innerHTML='<li class="collection-item grey-text">None</li>'; return; } names.forEach(n=>{ el.innerHTML+=`<li class="collection-item ${kind==='out'?'out':(kind==='in'?'in':'')}"><span><b>${n}</b></span></li>`; }); };
    renderList(listAdds,adds,'in'); renderList(listDrops,drops,'out');

    const instance=M.Modal.getInstance(confirmModal) || M.Modal.init(confirmModal,{dismissible:true});
    confirmBtn.onclick=async()=>{ if(confirmBtn.classList.contains('disabled')) return; confirmBtn.classList.add('disabled'); try{ if(mode==='firstxi'){ await buildFirstXI(); } else { await submitTransfers(); } } finally{ confirmBtn.classList.remove('disabled'); } };
    instance.open();
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    M.AutoInit();
    const stored=(()=>{ try{return localStorage.getItem('ml_email')||'';}catch(_){return'';} })(); if(stored){ emailEl.value=stored; } M.updateTextFields();

    // If API is not configured, skip network calls
    if(API.startsWith('PUT_')) return;

    await fetchAllPlayers();
    await fetchMatches();
    await fetchUserStats();
    await loadLeaderboard();

    document.addEventListener('input', e=>{
      if(e.target.id==='email'){ try{localStorage.setItem('ml_email', e.target.value||'');}catch(_){ } statsReady=false; fetchUserStats().then(()=>applyLastXIIfReady()); }
      if(e.target.id==='searchInput'){ renderPlayers(); }
    });
    teamFilter.addEventListener('change', renderPlayers);
    roleFilter.addEventListener('change', renderPlayers);
    matchSelectEl.addEventListener('change', ()=>{ statsReady=false; fetchUserStats(); });
    document.getElementById('refreshPlayers').addEventListener('click', fetchAllPlayers);
    document.getElementById('submitBtn').addEventListener('click', e=>{ e.preventDefault(); openConfirmModal('transfers'); });
    document.getElementById('buildFirstBtn').addEventListener('click', e=>{ e.preventDefault(); openConfirmModal('firstxi'); });
    document.getElementById('refreshLb').addEventListener('click', loadLeaderboard);
    clearAllBtn.addEventListener('click', e=>{ e.preventDefault(); document.querySelectorAll('#playersList input[type=checkbox]').forEach(cb=>cb.checked=false); updateSelectionUI(); });
  });
  </script>
</body>
</html>
``
