<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantasy League – DEBUG (GET submit + Echo)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    body { background:#f5f7fb; }
    nav .brand-logo { font-weight:800; }
    .grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:.5rem; }
    @media (max-width: 992px) { .grid { grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr;} }
    .chip-player { display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; background:#fff; border:1px solid #e0e0e0; border-radius:10px; }
    .sticky-actions { position: sticky; bottom: 0; background: #fff; padding: .75rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end; }
    /* DEBUG PANEL */
    .debug-panel { position: fixed; right: 12px; bottom: 12px; width: 420px; max-width: 95vw; background:#0d47a1; color:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.2); z-index:9999; }
    .debug-panel .head { display:flex; align-items:center; justify-content:space-between; padding:.6rem .9rem; background:#08306b; border-radius:10px 10px 0 0; }
    .debug-panel .body { padding:.75rem .9rem; max-height: 52vh; overflow:auto; background:#0d47a1; }
    .debug-panel pre { white-space: pre-wrap; word-break: break-all; font-size:.86rem; background: rgba(255,255,255,.1); padding:.5rem; border-radius:6px; }
    .debug-btns a { margin-right:.5rem; }
    .kv { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .86rem; }
    .kv b { color: #ffecb3; }
  </style>
</head>
<body>
  <nav class="blue">
    <div class="nav-wrapper container">
      <a href="#submit" class="brand-logo"><i class="material-icons">bug_report</i> Fantasy League – DEBUG</a>
      <ul class="right">
        <li><a href="#submit"><i class="material-icons left">send</i>Submit</a></li>
        <li><a href="#my-teams"><i class="material-icons left">view_week</i>My Teams</a></li>
      </ul>
    </div>
  </nav>

  <main class="container" style="margin-top:1.25rem;">

    <!-- Submit view (trimmed for debug) -->
    <section id="submit" class="view">
      <div class="card">
        <div class="card-content">
          <span class="card-title">Submit Team (DEBUG)</span>
          <div class="row">
            <div class="input-field col s12 m4">
              <input id="email" type="email" class="validate" placeholder="you@example.com">
              <label class="active" for="email">Your Email</label>
            </div>
            <div class="input-field col s12 m4">
              <input id="date" type="date" class="datepicker">
              <label class="active" for="date">Date</label>
            </div>
            <div class="input-field col s12 m4">
              <a id="submitBtn" class="btn waves-effect waves-light blue"><i class="material-icons left">send</i>Submit (GET)</a>
            </div>
          </div>
          <div>
            <label>Player Pool (mock for debug) – check 11</label>
            <div id="playersBox" class="grid"></div>
            <div class="grey-text">This debug file creates a simple mock list P1..P15 so you can test the pipeline even without your live players endpoint.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- My Teams minimal (only loader to verify endpoint) -->
    <section id="my-teams" class="view">
      <div class="card">
        <div class="card-content">
          <span class="card-title">My Teams (DEBUG mini)</span>
          <div class="row">
            <div class="input-field col s12 m6">
              <input id="email2" type="email" class="validate" placeholder="you@example.com">
              <label class="active" for="email2">Your Email</label>
            </div>
            <div class="input-field col s12 m3">
              <a id="loadBtn" class="btn waves-effect waves-light"><i class="material-icons left">cloud_download</i>Load</a>
            </div>
          </div>
          <pre id="myTeamsOut">(awaiting load)</pre>
        </div>
      </div>
    </section>

  </main>

  <!-- DEBUG PANEL -->
  <div class="debug-panel" id="debugPanel">
    <div class="head">
      <div><i class="material-icons" style="vertical-align:middle">bug_report</i> <b>Debug Console</b></div>
      <div class="debug-btns">
        <a class="btn-small yellow darken-3" id="btnEcho" target="_blank">Open Echo</a>
        <a class="btn-small grey darken-3" id="btnCopy">Copy URL</a>
        <a class="btn-small red darken-3" id="btnClear">Clear</a>
      </div>
    </div>
    <div class="body">
      <div class="kv"><b>API</b>: <span id="apiVal">(set below)</span></div>
      <div class="kv"><b>Final URL</b>: <span id="urlVal">—</span></div>
      <div class="kv"><b>Echo URL</b>: <span id="echoVal">—</span></div>
      <div class="kv"><b>Params</b>:</div>
      <pre id="paramOut">{}</pre>
      <div class="kv"><b>Response</b>:</div>
      <pre id="respOut">(no response yet)</pre>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
  /******** CONFIG ********/
  // Paste your Apps Script Web App /exec URL here
  const API = 'https://script.google.com/macros/s/AKfycbx0d02ONKNajQuoZwuwlimZ9bjdQ-rUQXBPLrrp0a7X3i2IwCt7pBQQEijHh8tudlIg/exec';
  document.getElementById('apiVal').textContent = API;

  /******** Helpers ********/
  function notify(msg) { M.toast({html: msg}); }
  function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
  function setView(hash){ document.querySelectorAll('section.view').forEach(s=>s.style.display='none'); const el=document.querySelector(hash)||document.querySelector('#submit'); el.style.display='block'; }
  function mkPlayerChips(){
    const box=document.getElementById('playersBox');
    box.innerHTML='';
    // create simple mock players P1..P15 for debug
    for(let i=1;i<=15;i++){
      const lab=document.createElement('label'); lab.className='chip-player';
      lab.innerHTML = `<label><input type="checkbox"/><span></span></label> <span>P${i}</span>`;
      lab.querySelector('input').value = `P${i}`;
      box.appendChild(lab);
    }
  }
  function selectedPlayers(){ return Array.from(document.querySelectorAll('#playersBox input[type=checkbox]:checked')).map(x=>x.value); }
  function paramPretty(obj){ try{ return JSON.stringify(obj, null, 2);}catch(e){ return String(obj);} }

  /******** Debug wiring ********/
  const urlVal = document.getElementById('urlVal');
  const echoVal= document.getElementById('echoVal');
  const paramOut = document.getElementById('paramOut');
  const respOut = document.getElementById('respOut');
  const btnEcho = document.getElementById('btnEcho');
  const btnCopy = document.getElementById('btnCopy');
  const btnClear= document.getElementById('btnClear');

  btnCopy.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(urlVal.textContent||''); notify('Copied final URL'); }catch(e){ notify('Copy failed'); }
  });
  btnClear.addEventListener('click', ()=>{ respOut.textContent='(cleared)'; });

  // Submit GET
  async function submitTeam(){
    const email = (document.getElementById('email').value||'').trim();
    const date  = document.getElementById('date').value;
    const players = selectedPlayers();
    if(!email||!date){ notify('Email & Date required'); return; }
    if(players.length!==11){ notify('Pick exactly 11 players'); return; }

    const qs = new URLSearchParams();
    qs.set('action','submitteam');
    qs.set('email', email);
    qs.set('date', date);
    qs.set('players', JSON.stringify(players));

    const finalUrl = `${API}?${qs.toString()}`;
    const echoUrl  = `${API}?action=echo&email=${encodeURIComponent(email)}&date=${encodeURIComponent(date)}&players=${encodeURIComponent(JSON.stringify(players))}`;
    urlVal.textContent = finalUrl;
    echoVal.textContent = echoUrl;
    paramOut.textContent = paramPretty({ action:'submitteam', email, date, players });
    btnEcho.setAttribute('href', echoUrl);

    try{
      const res = await fetch(finalUrl, { method:'GET' });
      const txt = await res.text();
      console.log('[submit][debug] status:', res.status, 'body:', txt);
      respOut.textContent = txt;
    }catch(e){ respOut.textContent = 'Network error: '+e; }
  }

  // MyTeams GET (quick visibility)
  async function loadMyTeams(){
    const email = (document.getElementById('email2').value||'').trim().toLowerCase();
    if(!email){ notify('Enter email'); return; }
    const url = `${API}?action=myteams&email=${encodeURIComponent(email)}&limit=10`;
    urlVal.textContent = url; echoVal.textContent = `${API}?action=echo&email=${encodeURIComponent(email)}`; btnEcho.setAttribute('href', echoVal.textContent);
    paramOut.textContent = paramPretty({ action:'myteams', email, limit:10 });
    try{ const r=await fetch(url); const t=await r.text(); document.getElementById('myTeamsOut').textContent=t; respOut.textContent=t; }catch(e){ respOut.textContent='Network error: '+e; }
  }

  // Init UI
  document.addEventListener('DOMContentLoaded', ()=>{
    M.AutoInit();
    const dps = document.querySelectorAll('.datepicker'); M.Datepicker.init(dps, { format:'yyyy-mm-dd', autoClose:true, defaultDate:new Date(), setDefaultDate:true });
    document.getElementById('date').value = todayISO();
    mkPlayerChips();
    setView(location.hash||'#submit');
    window.addEventListener('hashchange', ()=> setView(location.hash||'#submit'));
    document.getElementById('submitBtn').addEventListener('click', submitTeam);
    document.getElementById('loadBtn').addEventListener('click', loadMyTeams);
  });
  </script>
</body>
</html>
