
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Fever IPL Fantasy 2026</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    body { background:#f5f7fb; }
    nav .brand-logo { font-weight:800; }
    .card-title .badge { font-size:.8rem; margin-left:.5rem; }
    .team-columns { margin-top:.75rem; }
    .team-col { display:flex; flex-direction:column; gap:.8rem; }
    .player-card { background:#fff; border-radius:12px; padding:12px; display:flex; align-items:center; gap:14px; border:1px solid #e3e6ea; transition: box-shadow .2s ease, transform .15s ease; }
    .player-card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.09); transform: translateY(-2px); }
    .player-card .avatar { width:64px; height:64px; border-radius:8px; object-fit:cover; border:1px solid #e0e0e0; background:#fafafa; flex:0 0 auto; }
    .player-info { flex:1; display:flex; flex-direction:column; }
    .player-name { font-weight:600; font-size:1rem; }
    .player-team { font-size:.9rem; color:#607d8b; }
    .role-chip { font-size:.75rem; padding:.15rem .5rem; border-radius:12px; background:#eceff1; color:#263238; margin-left:.5rem; }
    .player-check { transform:scale(1.35); }
    .sticky-actions { position: sticky; bottom: 0; background:#fff; padding:.75rem; border-top:1px solid #eee; display:flex; flex-wrap:wrap; gap:.75rem; justify-content:space-between; align-items:center; }
    .team-meta { font-size:.95rem; color:#546e7a; }
    .sticky-head { position:sticky; top:0; background:white; z-index:2; border-bottom:1px solid #eee; }
    section.view { display:none; }
    section.view.active { display:block; }
    .chip-p { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; border-radius:16px; margin:0 .3rem .4rem 0; }
    .chip-common { background:#eceff1; color:#263238; }
    .chip-left-only { background:#e8f5e9; color:#1b5e20; }
    .chip-right-only { background:#e3f2fd; color:#0d47a1; }
    .chip-p img.avatar { width:24px; height:24px; margin-right:.35rem; vertical-align:middle; border-radius:50%; }

    /* Change budget panel */
    .budget { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
    .badge-inline { display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .6rem; border-radius:14px; background:#eceff1; color:#263238; font-size:.85rem; }
    .badge-inline .material-icons { font-size:18px; }
    .badge-ok { background:#e8f5e9; color:#1b5e20; }
    .badge-warn { background:#fff8e1; color:#e65100; }
    .badge-alert { background:#ffebee; color:#b71c1c; }

    /* Role composition panel */
    .composition { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .comp-box { background:#fff; border:1px solid #e0e0e0; border-radius:10px; padding:.35rem .6rem; font-size:.85rem; }
    .comp-bad { background:#ffebee; color:#b71c1c; border-color:#ffcdd2; }
    .comp-ok { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
  </style>
</head>
<body>
<nav class="blue">
  <div class="nav-wrapper container">
    <a href="#submit" class="brand-logo"><i class="material-icons">emoji_events</i> Sports Fever IPL Fantasy 2026</a>
    <ul class="right">
      <li><a href="#submit"><i class="material-icons left">send</i>Submit</a></li>
      <li><a href="#my-teams"><i class="material-icons left">view_week</i>My Teams</a></li>
    </ul>
  </div>
</nav>
<main class="container" style="margin-top:1.25rem;">
  <!-- =================== SUBMIT VIEW =================== -->
  <section id="submit" class="view active">
    <div class="row">
      <div class="col l7 s12">
        <div class="card">
          <div class="card-content">
            <span class="card-title">Submit Team
              <span class="new badge blue" id="selCount" data-badge-caption="/11 selected">0</span>
            </span>
            <div class="row">
              <div class="input-field col s12 m6">
                <input id="email" type="email" class="validate" placeholder="you@example.com">
                <label class="active" for="email">Your Email</label>
              </div>
              <div class="input-field col s12 m6">
                <select id="matchSelect"></select>
                <label>Match</label>
              </div>
            </div>

            <!-- Budget summary -->
            <div class="budget" id="budgetPanel" style="margin-bottom:.5rem;">
              <span class="badge-inline" id="badgeToday"><i class="material-icons">sync_alt</i> Today: <b id="todayChanges">0</b> changes</span>
              <span class="badge-inline" id="badgeUsed"><i class="material-icons">timelapse</i> Used: <b id="usedSoFar">0</b></span>
              <span class="badge-inline" id="badgeRemain"><i class="material-icons">battery_std</i> Remaining: <b id="remaining">100</b></span>
              <span class="badge-inline" id="badgeBudget"><i class="material-icons">flag</i> Budget: <b id="budget">100</b></span>
            </div>

            <!-- Composition rules -->
            <div class="composition" id="compositionPanel" style="margin-bottom:.5rem;">
              <span><b>Role rules</b>:</span>
              <span class="comp-box" id="ruleWK">WK: —</span>
              <span class="comp-box" id="ruleBAT">BAT: —</span>
              <span class="comp-box" id="ruleAR">AR: —</span>
              <span class="comp-box" id="ruleBOWL">BOWL: —</span>
            </div>

            <label>Player Pool (for selected match)</label>
            <div class="row team-columns">
              <div class="col s12 m6">
                <h6 id="teamLeftTitle"><b>Team A</b></h6>
                <div id="playersLeft" class="team-col"></div>
              </div>
              <div class="col s12 m6">
                <h6 id="teamRightTitle"><b>Team B</b></h6>
                <div id="playersRight" class="team-col"></div>
              </div>
            </div>
            <p class="grey-text">We preselect your last XI. Change only what you need—change budget and role rules are enforced.</p>
          </div>
          <div class="sticky-actions">
            <a id="refreshPlayers" class="btn-flat waves-effect"><i class="material-icons left">refresh</i>Reload</a>
            <a id="submitBtn" class="btn waves-effect waves-light blue disabled"><i class="material-icons left">send</i>Submit Team</a>
          </div>
        </div>
      </div>
      <div class="col l5 s12">
        <div class="card">
          <div class="card-content">
            <span class="card-title">Leaderboard <a id="refreshLb" class="btn-flat right"><i class="material-icons">autorenew</i></a></span>
            <table class="striped highlight responsive-table">
              <thead>
                <tr><th>#</th><th>User</th><th>Points</th></tr>
              </thead>
              <tbody id="lbTable"><tr><td colspan="3">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin modal -->
    <div id="adminModal" class="modal">
      <div class="modal-content">
        <h5>Admin: Update Player Points</h5>
        <div class="row">
          <div class="input-field col s12"><input id="adminToken" type="password"><label for="adminToken">Admin token</label></div>
          <div class="input-field col s12 m6"><select id="adminMatch"></select><label>Match</label></div>
          <div class="input-field col s12 m6"><input id="adminPoints" type="number"><label for="adminPoints">Points</label></div>
          <div class="input-field col s12"><input id="adminPlayer" type="text"><label for="adminPlayer">Player Name</label></div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#" id="adminSetPoints" class="modal-close waves-effect waves-green btn red">Set Points</a>
      </div>
    </div>
  </section>

  <!-- =================== MY TEAMS VIEW =================== -->
  <section id="my-teams" class="view">
    <div class="card">
      <div class="card-content">
        <span class="card-title">View & Compare Your Teams</span>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="email2" type="email" class="validate" placeholder="you@example.com">
            <label class="active" for="email2">Your Email</label>
            <span class="helper-text">We’ll remember it on this device.</span>
          </div>
          <div class="input-field col s12 m3">
            <input id="limit" type="number" min="1" max="100" value="5">
            <label class="active" for="limit">How many recent teams?</label>
          </div>
          <div class="input-field col s12 m3">
            <a id="loadBtn" class="btn waves-effect waves-light blue"><i class="material-icons left">cloud_download</i>Load</a>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col l6 s12">
        <div class="card">
          <div class="card-content">
            <div class="sticky-head" style="padding-bottom:.5rem;">
              <span class="card-title" style="margin-bottom:0;">Latest Team</span>
              <div class="team-meta" id="leftMeta">—</div>
            </div>
            <div id="leftPlayers" style="margin-top:.75rem;">Load to view…</div>
          </div>
        </div>
      </div>
      <div class="col l6 s12">
        <div class="card">
          <div class="card-content">
            <div class="sticky-head" style="padding-bottom:.5rem;">
              <span class="card-title" style="margin-bottom:0;">Compare With</span>
              <div class="row" style="margin-bottom:0;">
                <div class="input-field col s12 m8">
                  <select id="compareSelect"></select>
                  <label>Select a previous submission</label>
                </div>
                <div class="input-field col s12 m4">
                  <div class="team-meta" id="overlapMeta" style="margin-top:.75rem;">—</div>
                </div>
              </div>
              <div class="team-meta" id="rightMeta">—</div>
            </div>
            <div id="rightPlayers" style="margin-top:.75rem;">Load to view…</div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-content">
        <span class="card-title">Recent Submissions</span>
        <table class="highlight responsive-table">
          <thead>
            <tr><th>#</th><th>Match</th><th>Points</th><th>Changes</th><th>Entry ID</th><th>View</th></tr>
          </thead>
          <tbody id="listBody"><tr><td colspan="6">—</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  const API = 'https://script.google.com/macros/s/AKfycbz_M2B-WY4aASsTOwryQXSHHFDanFFLc9LsJuHSf1KlWtXDt9tPN-5cryUZAy8OjeUq/exec';

  function activateView(hash){
    const target = (hash || location.hash || '#submit').replace('#','');
    document.querySelectorAll('section.view').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById(target) || document.getElementById('submit');
    el.classList.add('active');
  }
  window.addEventListener('hashchange', ()=> activateView(location.hash));
  function notify(msg) { M.toast({html: msg}); }

  // SUBMIT VIEW
  const emailEl = document.getElementById('email');
  const submitBtn = document.getElementById('submitBtn');
  const selCount = document.getElementById('selCount');
  const lbTable = document.getElementById('lbTable');
  const refreshLbBtn = document.getElementById('refreshLb');
  const matchSelectEl = document.getElementById('matchSelect');
  const playersLeftBox = document.getElementById('playersLeft');
  const playersRightBox = document.getElementById('playersRight');
  const teamLeftTitleEl = document.getElementById('teamLeftTitle');
  const teamRightTitleEl = document.getElementById('teamRightTitle');

  const badgeToday = document.getElementById('todayChanges');
  const badgeUsed = document.getElementById('usedSoFar');
  const badgeRemain = document.getElementById('remaining');
  const badgeBudget = document.getElementById('budget');

  const ruleWK = document.getElementById('ruleWK');
  const ruleBAT = document.getElementById('ruleBAT');
  const ruleAR = document.getElementById('ruleAR');
  const ruleBOWL = document.getElementById('ruleBOWL');

  let constraints = { WK:{min:1,max:2}, BAT:{min:3,max:6}, AR:{min:1,max:4}, BOWL:{min:3,max:6} };
  const playerImgMap = {}; const playerRoleMap = {};
  let lastTeamPlayers = []; let userBudget = 100, userUsed = 0, userRemaining = 100;

  function formatRole(r){ if(!r) return '—'; r = String(r).trim().toUpperCase(); if(r==='WICKETKEEPER') return 'WK'; if(r==='BATSMAN' || r==='BATTER') return 'BAT'; if(r.startsWith('ALL')) return 'AR'; if(r==='BOWLER') return 'BOWL'; return r; }

  function selectedPlayers(){
    return Array.from(document.querySelectorAll('#playersLeft input[type=checkbox]:checked, #playersRight input[type=checkbox]:checked')).map(x => x.value);
  }

  function countChanges(prevArr, currArr){ const size=11; const s=new Set(prevArr||[]); let overlap=0; (currArr||[]).forEach(p=>{ if(s.has(p)) overlap++; }); return size-overlap; }

  function countRoles(list){ const c={WK:0,BAT:0,AR:0,BOWL:0,UNKNOWN:0}; (list||[]).forEach(p=>{ const r = formatRole(playerRoleMap[p]||''); if(c[r]===undefined) c.UNKNOWN++; else c[r]++; }); return c; }

  function updateRuleBadges(counts){
    const setBox=(el, label, val, min, max)=>{
      el.textContent = `${label}: ${val} (min ${min}, max ${max})`;
      el.classList.remove('comp-ok','comp-warn','comp-bad');
      if(val<min || val>max) el.classList.add('comp-bad');
      else el.classList.add('comp-ok');
    };
    setBox(ruleWK, 'WK', counts.WK, constraints.WK.min, constraints.WK.max);
    setBox(ruleBAT, 'BAT', counts.BAT, constraints.BAT.min, constraints.BAT.max);
    setBox(ruleAR, 'AR', counts.AR, constraints.AR.min, constraints.AR.max);
    setBox(ruleBOWL, 'BOWL', counts.BOWL, constraints.BOWL.min, constraints.BOWL.max);
  }

  function updateBadges(changesToday){
    badgeToday.textContent = String(changesToday);
    badgeUsed.textContent = String(userUsed + changesToday);
    badgeRemain.textContent = String(Math.max(0, userBudget - (userUsed + changesToday)));
    badgeBudget.textContent = String(userBudget);
    const remain = userBudget - (userUsed + changesToday);
    const container = document.getElementById('budgetPanel');
    container.querySelectorAll('.badge-inline').forEach(tag=>{
      tag.classList.remove('badge-ok','badge-warn','badge-alert');
      if(remain < 0) tag.classList.add('badge-alert');
      else if(remain <= 10) tag.classList.add('badge-warn');
      else tag.classList.add('badge-ok');
    });
  }

  function updateSelectionUI(){
    const chosen = selectedPlayers();
    const n = chosen.length;
    selCount.setAttribute('data-badge-caption','/11 selected');
    selCount.textContent = n;
    const changes = countChanges(lastTeamPlayers, chosen);
    updateBadges(changes);
    const rc = countRoles(chosen);
    updateRuleBadges(rc);
    const roleValid = rc.WK>=constraints.WK.min && rc.WK<=constraints.WK.max && rc.BAT>=constraints.BAT.min && rc.BAT<=constraints.BAT.max && rc.AR>=constraints.AR.min && rc.AR<=constraints.AR.max && rc.BOWL>=constraints.BOWL.min && rc.BOWL<=constraints.BOWL.max;
    if (!emailEl.value || !matchSelectEl.value || n !== 11 || (userUsed + changes) > userBudget || !roleValid) {
      submitBtn.classList.add('disabled');
    } else {
      submitBtn.classList.remove('disabled');
    }
  }

  function detectTeams(list, matchLabel){
    const counts = {}; (list||[]).forEach(p=>{ const t=(p&&p.team? String(p.team).trim(): ''); if(!t) return; counts[t]=(counts[t]||0)+1; });
    const codes = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
    if(codes.length>=2) return {left:codes[0], right:codes[1]};
    const lbl = matchLabel||''; const m = lbl.match(/([A-Z]{2,3})\s*vs\s*([A-Z]{2,3})/i);
    if(m){ return {left:m[1].toUpperCase(), right:m[2].toUpperCase()}; }
    return {left:codes[0]||'Team A', right:codes[1]||'Team B'};
  }

  function renderPlayers(list, matchLabel){
    playersLeftBox.innerHTML = ''; playersRightBox.innerHTML = '';
    const teams = detectTeams(list, matchLabel); teamLeftTitleEl.innerHTML = `<b>Team ${teams.left}</b>`; teamRightTitleEl.innerHTML = `<b>Team ${teams.right}</b>`;
    if (!Array.isArray(list) || list.length === 0){ playersLeftBox.innerHTML = '<span class="grey-text">No players found for this match.</span>'; return; }
    list.forEach(p=>{ playerRoleMap[p.name] = p.role || ''; });
    list.forEach(p => {
      const card = document.createElement('div'); card.className = 'player-card';
      const imgSrc = p.imageUrl || p.image || p.img || p.PlayerImageURL || p.photo || '';
      if (p && p.name && imgSrc) playerImgMap[p.name] = imgSrc;
      const imgEl = document.createElement(imgSrc ? 'img' : 'i');
      if (imgSrc){ imgEl.className = 'avatar'; imgEl.loading='lazy'; imgEl.decoding='async'; imgEl.referrerPolicy='no-referrer'; imgEl.src = imgSrc; imgEl.onerror = function(){ this.remove(); } }
      else { imgEl.className = 'material-icons grey-text'; imgEl.textContent = 'person'; }
      const label = document.createElement('label'); label.className = 'player-check'; label.innerHTML = '<input type="checkbox"/><span></span>';
      label.querySelector('input').value = p.name;
      const info = document.createElement('div'); info.className = 'player-info';
      const roleShort = formatRole(p.role||'');
      info.innerHTML = `<span class="player-name">${p.name}<span class="role-chip">${roleShort}</span></span><span class="player-team">(${p.team||''})</span>`;
      card.appendChild(label); card.appendChild(imgEl); card.appendChild(info);
      const teamCode = (p.team||'').toUpperCase();
      if (teamCode === String(teams.left).toUpperCase()) playersLeftBox.appendChild(card);
      else if (teamCode === String(teams.right).toUpperCase()) playersRightBox.appendChild(card);
      else (playersLeftBox.children.length <= playersRightBox.children.length ? playersLeftBox : playersRightBox).appendChild(card);
    });
    document.querySelectorAll('#playersLeft input[type=checkbox], #playersRight input[type=checkbox]').forEach(cb => cb.addEventListener('change', updateSelectionUI));
    preselectLastTeam(); updateSelectionUI();
  }

  async function fetchMatches(){
    try{
      const res = await fetch(`${API}?action=matches`); const txt = await res.text();
      let j; try { j = JSON.parse(txt); } catch(e){ notify('Response not JSON (matches)'); return; }
      if(!j.ok){ notify(j.error || 'API error (matches)'); return; }
      const list = Array.isArray(j.matches) ? j.matches : [];
      const opts = ['<option value="">-- Select Match --</option>'];
      list.forEach(m => { opts.push(`<option value="${m.id}">${m.label || m.match}</option>`); });
      matchSelectEl.innerHTML = opts.join('');
      M.FormSelect.init(matchSelectEl);
      if(list.length){ matchSelectEl.value = String(list[0].id); M.FormSelect.init(matchSelectEl); fetchPlayers(); }
    }catch(err){ notify('Network error while loading matches'); }
  }

  async function fetchPlayers(){
    const left = document.getElementById('playersLeft'); left.innerHTML='Loading players…'; document.getElementById('playersRight').innerHTML=''; selCount.textContent='0';
    try{
      const matchId = matchSelectEl.value; const url = `${API}?action=players&matchId=${encodeURIComponent(matchId)}`;
      const res = await fetch(url); const txt = await res.text(); let j; try{ j = JSON.parse(txt);}catch(e){ left.innerHTML='<span class="red-text">Response not JSON.</span>'; return; }
      if(!j.ok){ left.innerHTML = `<span class="red-text">${j.error || 'API error'}</span>`; return; }
      const matchLabel = (function(){ const opt = matchSelectEl.options[matchSelectEl.selectedIndex]; return opt ? opt.text : ''; })();
      renderPlayers(j.players||[], matchLabel);
    }catch(err){ left.innerHTML='<span class="red-text">Network error</span>'; }
  }

  async function fetchUserStats(){
    const email = (emailEl.value || '').trim().toLowerCase(); if(!email) return;
    try{
      const res = await fetch(`${API}?action=userstats&email=${encodeURIComponent(email)}`);
      const txt = await res.text(); let j; try{ j = JSON.parse(txt);}catch(e){ notify('Stats response not JSON'); return; }
      if(!j.ok){ notify(j.error || 'Stats error'); return; }
      userBudget = Number(j.budget || 100); userUsed = Number(j.used || 0); userRemaining = Number(j.remaining || Math.max(0, userBudget - userUsed));
      lastTeamPlayers = Array.isArray(j.lastTeam)? j.lastTeam : [];
      if (j.constraints) constraints = j.constraints;
      ruleWK.textContent  = `WK: — (min ${constraints.WK.min}, max ${constraints.WK.max})`;
      ruleBAT.textContent = `BAT: — (min ${constraints.BAT.min}, max ${constraints.BAT.max})`;
      ruleAR.textContent  = `AR: — (min ${constraints.AR.min}, max ${constraints.AR.max})`;
      ruleBOWL.textContent= `BOWL: — (min ${constraints.BOWL.min}, max ${constraints.BOWL.max})`;
      updateBadges(0);
    }catch(e){ }
  }

  function preselectLastTeam(){
    const map = new Map();
    document.querySelectorAll('#playersLeft input[type=checkbox], #playersRight input[type=checkbox]').forEach(cb => { map.set(cb.value, cb); });
    let count = 0; (lastTeamPlayers || []).forEach(p => { if(map.has(p) && count < 11){ map.get(p).checked = true; count++; } });
  }

  async function submitTeam(){
    const email = (emailEl.value || '').trim();
    const players = selectedPlayers();
    if (!email || !matchSelectEl.value){ notify('Email & Match required'); return; }
    if (players.length !== 11){ notify('Pick exactly 11 players'); return; }
    submitBtn.classList.add('disabled');
    try{
      const qs = new URLSearchParams(); qs.set('action','submitteam'); qs.set('email', email); qs.set('matchId', matchSelectEl.value); qs.set('players', JSON.stringify(players));
      const res = await fetch(`${API}?${qs.toString()}`, { method:'GET' }); const raw = await res.text(); let j; try { j = JSON.parse(raw); } catch (e) { notify('Response not JSON.'); return; }
      if (j.ok){ notify('Submitted!'); await fetchUserStats(); lastTeamPlayers = players.slice(); updateSelectionUI(); }
      else {
        if (j.code === 'INSUFFICIENT_CHANGES') notify(`Not enough changes. Need ${j.needed}, remaining ${j.remaining}.`);
        else if (j.code === 'ROLE_INVALID') {
          const d = j.details||{}; if (d.issues && d.issues.length) notify('Role rule errors: ' + d.issues.join(', '));
          else if (d.missing && d.missing.length) notify('Role missing for: ' + d.missing.join(', '));
          else notify(j.error||'Role constraints failed');
        } else notify(j.error || 'Submission failed');
      }
    }catch(e){ notify('Network error while submitting'); }
    finally{ submitBtn.classList.remove('disabled'); }
  }

  async function loadLeaderboard(){
    const table = document.getElementById('lbTable'); table.innerHTML='<tr><td colspan="3">Loading…</td></tr>';
    try{ const res=await fetch(`${API}?action=leaderboard`); const txt=await res.text(); let j; try{ j=JSON.parse(txt);}catch(e){ table.innerHTML='<tr><td colspan="3" class="red-text">Response not JSON</td></tr>'; return; } if(!j.ok){ table.innerHTML = `<tr><td colspan="3" class="red-text">${j.error || 'API error'}</td></tr>`; return; } table.innerHTML = (j.leaderboard||[]).map((r,i)=>`<tr><td>${i+1}</td><td>${r.name || ''}</td><td><span class="new badge green" data-badge-caption="">${r.total}</span></td></tr>`).join('') || '<tr><td colspan="3" class="grey-text">No data yet.</td></tr>'; }catch(e){ table.innerHTML='<tr><td colspan="3" class="red-text">Failed</td></tr>'; }
  }

  document.addEventListener('DOMContentLoaded', function(){
    M.AutoInit();
    const stored = (function(){ try { return localStorage.getItem('ml_email') || ''; } catch(_) { return ''; } })();
    if (stored) { emailEl.value = stored; document.getElementById('email2').value = stored; }
    M.updateTextFields();
    fetchMatches(); loadLeaderboard(); activateView(location.hash || '#submit');
    document.addEventListener('input', (e)=>{
      if (e.target.id==='email'){ try{ localStorage.setItem('ml_email', e.target.value || ''); }catch(_){ } fetchUserStats().then(()=>updateSelectionUI()); }
      if (e.target.id==='email2'){ try{ localStorage.setItem('ml_email', e.target.value || ''); }catch(_){ } }
      if (e.target.id==='matchSelect'){ updateSelectionUI(); }
    });
    matchSelectEl.addEventListener('change', async ()=>{ await fetchPlayers(); await fetchUserStats(); updateSelectionUI(); });
    document.getElementById('submitBtn').addEventListener('click', submitTeam);
    document.getElementById('refreshPlayers').addEventListener('click', fetchPlayers);
    document.getElementById('refreshLb').addEventListener('click', loadLeaderboard);
    document.getElementById('loadBtn').addEventListener('click', loadMyTeams);
  });

  // ---- My Teams (same as earlier) ----
  const email2El = document.getElementById('email2');
  const limitEl = document.getElementById('limit');
  const leftMeta = document.getElementById('leftMeta');
  const rightMeta = document.getElementById('rightMeta');
  const overlapMeta = document.getElementById('overlapMeta');
  const leftPlayersBox = document.getElementById('leftPlayers');
  const rightPlayersBox = document.getElementById('rightPlayers');
  const compareSelect = document.getElementById('compareSelect');
  const listBody = document.getElementById('listBody');

  function setStoredEmail(v){ try { localStorage.setItem('ml_email', v || ''); } catch(_){} }
  function makeChip(player, cls){ const span = document.createElement('span'); span.className = 'chip-p ' + cls; const imgUrl = playerImgMap[player]; if (imgUrl){ const img = document.createElement('img'); img.className = 'avatar'; img.loading='lazy'; img.decoding='async'; img.referrerPolicy='no-referrer'; img.src = imgUrl; img.onerror = function(){ this.remove(); }; span.appendChild(img); } const text = document.createElement('span'); text.textContent = player; span.appendChild(text); return span; }
  function renderTeamPlayers(container, players, compareSet, side){ container.innerHTML=''; const ownSet=new Set(players||[]); const onlyOwn = [...ownSet].filter(p=>!compareSet.has(p)); const common = [...ownSet].filter(p=>compareSet.has(p)); common.forEach(p=>container.appendChild(makeChip(p,'chip-common'))); if (side==='left') onlyOwn.forEach(p=>container.appendChild(makeChip(p,'chip-left-only'))); else onlyOwn.forEach(p=>container.appendChild(makeChip(p,'chip-right-only'))); }
  function overlapCount(a,b){ const s=new Set(a||[]); return (b||[]).reduce((acc,x)=>acc+(s.has(x)?1:0),0); }
  function setTeamMeta(el, team){ el.textContent = team ? `Match: ${team.matchLabel || '-'} • Points: ${team.points} • Changes: ${team.changesUsed ?? '-'} • ID: ${team.entryId}` : '—'; }
  function buildCompareOptions(teams){ const opts=['<option value="">-- Select --</option>']; teams.slice(1).forEach(t=>opts.push(`<option value="${t.entryId}">${t.matchLabel || '-'} (Pts ${t.points}, Chg ${t.changesUsed ?? '-'})</option>`)); compareSelect.innerHTML = opts.join(''); M.FormSelect.init(compareSelect); }
  function selectRight(entryId){ const allTeams = window._allTeams || []; const t = allTeams.find(x=>x.entryId===entryId); if(!t) return; const leftSet=new Set((window._latestTeam||{}).players||[]); setTeamMeta(rightMeta,t); const o=overlapCount((window._latestTeam||{}).players||[], t.players||[]); overlapMeta.textContent=`Common: ${o} / 11`; renderTeamPlayers(rightPlayersBox, t.players||[], leftSet, 'right'); compareSelect.value=entryId; M.FormSelect.init(compareSelect); }
  window.selectRight = selectRight;

  async function loadMyTeams(){
    const email=(email2El.value || '').trim().toLowerCase(); if(!email){ notify('Please enter your email'); return; }
    setStoredEmail(email); const limit=Number(limitEl.value || 20);
    const url=`${API}?action=myteams&email=${encodeURIComponent(email)}&limit=${encodeURIComponent(limit)}`;
    try{ const res=await fetch(url); const txt=await res.text(); let j; try{ j=JSON.parse(txt);}catch(e){ notify('Response not JSON'); return;} if(!j.ok){ notify(j.error || 'API error'); return;}
      const latest=j.latest || null; const items=Array.isArray(j.items)?j.items:[]; window._latestTeam=latest; window._allTeams=items;
      if(!latest){ leftMeta.textContent='No submissions yet.'; leftPlayersBox.innerHTML=''; rightMeta.textContent='—'; rightPlayersBox.innerHTML=''; overlapMeta.textContent='—'; compareSelect.innerHTML=''; M.FormSelect.init(compareSelect); listBody.innerHTML='<tr><td colspan="6">No submissions yet.</td></tr>'; return; }
      setTeamMeta(leftMeta, latest); renderTeamPlayers(leftPlayersBox, latest.players||[], new Set(), 'left');
      buildCompareOptions(items);
      if(items.length>1){ selectRight(items[1].entryId); } else { rightMeta.textContent='No previous team to compare.'; rightPlayersBox.innerHTML=''; overlapMeta.textContent='—'; }
      listBody.innerHTML = items.map((t,i)=>`<tr><td>${i+1}</td><td>${t.matchLabel || '-'}</td><td>${t.points}</td><td>${t.changesUsed ?? '-'}</td><td class="grey-text text-darken-1">${t.entryId}</td><td><a class="btn-flat waves-effect" onclick="selectRight('${t.entryId}')"><i class="material-icons left">compare</i>Compare</a></td></tr>`).join('');
    } catch(err){ notify('Network error while loading teams'); }
  }
</script>
</body>
</html>
