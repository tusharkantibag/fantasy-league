<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sports Fever IPL Fantasy 2026</title>

<!-- Materialize CSS -->
https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css
https://fonts.googleapis.com/icon?family=Material+Icons

<style>
  /* Light base styles (you can theme as you like) */
  body { background:#f5f7fb; color:#222; }
  nav .brand-logo { font-weight:800; }
  section.view { display:none; }
  section.view.active { display:block; }
  .sticky-actions { position: sticky; bottom: 0; background:#fff; padding:.75rem; border-top:1px solid #eee; display:flex; gap:.5rem; justify-content:flex-end; }
  .sticky-head { position:sticky; top:0; background:#fff; z-index:2; border-bottom:1px solid #eee; }

  /* Two-team layout during submission */
  .teams-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:1rem; }
  @media (max-width:800px){ .teams-grid{ grid-template-columns:1fr; } }
  .p-list{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.5rem; }
  @media (max-width:520px){ .p-list{ grid-template-columns:1fr; } }

  .p-card{
    display:flex; align-items:center; gap:.75rem;
    background:#fff; border:1px solid #e0e0e0; border-radius:12px; padding:.5rem .75rem;
  }
  .p-card img{ width:38px; height:38px; border-radius:50%; object-fit:cover; background:#fafafa; border:1px solid #eee; }
  .p-name{ font-weight:600; }
  .p-team{ font-size:.8rem; color:#6b7c8a; }

  /* Chips for compare (with images) */
  .chip-p{
    display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .6rem; border-radius:16px;
    margin:0 .35rem .35rem 0; background:#eceff1; color:#263238; border:1px solid #d8dee3;
  }
  .chip-p img{ width:22px; height:22px; border-radius:50%; object-fit:cover; }
  .chip-common{ background:#cfd8dc; }
  .chip-left-only{ background:#e8f5e9; }
  .chip-right-only{ background:#e3f2fd; }
  .team-meta{ font-size:.95rem; color:#546e7a; }
</style>
</head>
<body>
  <nav class="blue">
    <div class="nav-wrapper container">
      <a href="#submit" class="brand-logo"><i class="material-icons">emoji_events</i> Sports Fever IPL Fantasy 2026</a>
      <ul class="right">
        <li><a href="#submit"><i class="material-icons left">send</i>Submit</a></li>
        <li><a href="#my-teams"><i class="material-icons left">view_week</i>My Teams</a></li>
      </ul>
    </div>
  </nav>

  <main class="container" style="margin-top:1.25rem;">
    <!-- SUBMIT -->
    <section id="submit" class="view active">
      <div class="row">
        <div class="col l7 s12">
          <div class="card">
            <div class="card-content">
              <span class="card-title">
                Submit Team
                <span class="new badge blue" id="selCount" data-badge-caption="/11 selected">0</span>
              </span>

              <div class="row">
                <div class="input-field col s12 m6">
                  <input id="email" type="email" class="validate" placeholder="you@example.com">
                  <label class="active" for="email">Your Email</label>
                </div>
                <!-- Match Number selector -->
                <div class="input-field col s12 m6">
                  <select id="mber</label>
                </div>
              </div>

              <label>Players (for selected match)</label>
              <div id="teamsBox" class="teams-grid">Loading players…</div>
              <p class="grey-text">Select exactly 11 players.</p>
            </div>
            <div class="sticky-actions">
              <a id="refreshPlayers" class="btn-flat waves-effect"><i class="material-icons left">refresh</i>Reload</a>
              <a id="submitBtn" class="btn waves-effect waves-light blue disabled"><i class="material-icons left">send</i>Submit Team</a>
            </div>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="col l5 s12">
          <div class="card">
            <div class="card-content">
              <span class="card-title">Leaderboard
                <a id="refreshLb" class="btn-flat right"><i class="material-icons">autorenew</i></a>
              </span>
              <table class="striped highlight responsive-table">
                <thead>
                  <tr><th>#</th><th>User</th><th>Email</th><th>Points</th></tr>
                </thead>
                <tbody id="lbTable"><tr><td colspan="4">Loading…</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin modal (matchNo-based) -->
      <div id="adminModal" class="modal">
        <div class="modal-content">
          <h5>Admin: Update Player Points</h5>
          <div class="row">
            <div class="input-field col s12">
              <input id="adminToken" type="password">
              <label for="adminToken">Admin token</label>
            </div>
            <div class="input-field col s12 m6">
              <input id="adminMatchNo" type="number" min="1">
              <label class="active" for="adminMatchNo">Match No</label>
            </div>
            <div class="input-field col s12 m6">
              <input id="adminPoints" type="number">
              <label for="adminPoints">Points</label>
            </div>
            <div class="input-field col s12">
              <input id="adminPlayer" type="text">
              <label for="adminPlayer">Player Name</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <a href="#!" id="adminSetPoints" class="modal-close waves-effect waves-green btn red">Set Points</a>
        </div>
      </div>
    </section>

    <!-- MY TEAMS -->
    <section id="my-teams" class="view">
      <div class="card">
        <div class="card-content">
          <span class="card-title">View & Compare Your Teams</span>
          <div class="row">
            <div class="input-field col s12 m6">
              <input id="email2" type="email" class="validate" placeholder="you@example.com">
              <label class="active" for="email2">Your Email</label>
              <span class="helper-text">We’ll remember it on this device.</span>
            </div>
            <div class="input-field col s12 m3">
              <input id="limit" type="number" min="1" max="100" value="2">
              <label class="active" for="limit">How many recent teams?</label>
            </div>
            <div class="input-field col s12 m3">
              <a id="loadBtn" class="btn waves-effect waves-light blue"><i class="material-icons left">cloud_download</i>Load</a>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Latest -->
        <div class="col l6 s12">
          <div class="card">
            <div class="card-content">
              <div class="sticky-head" style="padding-bottom:.5rem;">
                <span class="card-title" style="margin-bottom:0;">Latest Team</span>
                <div class="team-meta" id="leftMeta">—</div>
              </div>
              <div id="leftPlayers" style="margin-top:.75rem;">Load to view…</div>
            </div>
          </div>
        </div>

        <!-- Compare with -->
        <div class="col l6 s12">
          <div class="card">
            <div class="card-content">
              <div class="sticky-head" style="padding-bottom:.5rem;">
                <span class="card-title" style="margin-bottom:0;">Compare With</span>
                <div class="row" style="margin-bottom:0;">
                  <div class="input-field col s12 m8">
                    <select id="compareSelect"></select>
                    <label>Select a previous submission</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <div class="team-meta" id="overlapMeta" style="margin-top:.75rem;">—</div>
                  </div>
                </div>
                <div class="team-meta" id="rightMeta">—</div>
              </div>
              <div id="rightPlayers" style="margin-top:.75rem;">Load to view…</div>
            </div>
          </div>
        </div>
      </div>

      <!-- List -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">Recent Submissions</span>
          <table class="highlight responsive-table">
            <thead>
              <tr><th>#</th><th>Match No</th><th>Points</th><th>Entry ID</th><th>View</th></tr>
            </thead>
            <tbody id="listBody"><tr><td colspan="5">—</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1. URL:
    const API = 'https://script.google.com/macros/s/AKfycby_9hA7hrhLfsE_zmdaVEzTycOZ_yvVl3nf29PWu99Q2_hL2UCR84sgKfMeVPE_spM/exec';

    function activateView(hash){
      const target = (hash || location.hash || '#submit').replace('#','');
      document.querySelectorAll('section.view').forEach(s => s.classList.remove('active'));
      (document.getElementById(target) || document.getElementById('submit')).classList.add('active');
    }
    window.addEventListener('hashchange', ()=>activateView(location.hash));
    function notify(msg){ M.toast({html: msg}); }

    // ---- Submit elements ----
    const emailEl = document.getElementById('email');
    const matchNoSel = document.getElementById('matchNo');
    const teamsBox = document.getElementById('teamsBox');
    const submitBtn = document.getElementById('submitBtn');
    const selCount = document.getElementById('selCount');
    const lbTable = document.getElementById('lbTable');

    const adminTokenEl = document.getElementById('adminToken');
    const adminMatchNoEl = document.getElementById('adminMatchNo');
    const adminPointsEl = document.getElementById('adminPoints');
    const adminPlayerEl = document.getElementById('adminPlayer');

    function selectedPlayers(){
      return Array.from(teamsBox.querySelectorAll('input[type=checkbox]:checked')).map(x => x.value);
    }
    function updateSelectionUI(){
      const n = selectedPlayers().length;
      selCount.setAttribute('data-badge-caption','/11 selected');
      selCount.textContent = n;
      if (!emailEl.value || !matchNoSel.value || n !== 11) submitBtn.classList.add('disabled');
      else submitBtn.classList.remove('disabled');
    }

    // --- Build two buckets by team (top 2 by count) ---
    function twoTeamBuckets(players){
      const byTeam = new Map();
      players.forEach(p => {
        const key = (p.team || 'TEAM').toUpperCase();
        if (!byTeam.has(key)) byTeam.set(key, []);
        byTeam.get(key).push(p);
      });
      const sorted = [...byTeam.entries()].sort((a,b)=> b[1].length - a[1].length);
      const pick = sorted.slice(0, 2).map(([team, list]) => ({team, list}));
      return pick.length ? pick : [{team:'Team A', list:players.slice(0,Math.ceil(players.length/2))},
                                   {team:'Team B', list:players.slice(Math.ceil(players.length/2))}];
    }

    function playerCardHTML(p){
      const imgTag = p.image ? `<img src="${p.image}" alt="${p.name}">` : `<img src="" alt="">`;
      return `
        <label class="p-card">
          <label><input type="checkbox"/><span></span></label>
          ${imgTag}
          <div>
            <div class="p-name">${p.name}</div>
            <div class="p-team">${p.team||''}</div>
          </div>
        </label>`;
    }

   ms(players){
      if (!Array.isArray(players) || players.length === 0){
        teamsBox.innerHTML = '<span class="grey-text">No players found for this match.</span>';
        updateSelectionUI(); return;
      }
      const buckets = twoTeamBuckets(players);
      teamsBox.innerHTML = buckets.map(b => `
        <div>
          <h6 style="font-weight:800; margin:0 0 .5rem 0;">${b.team}</h6>
          <div class="p-list">${b.list.map(playerCardHTML).join('')}</div>
        </div>
      `).join('');
      teamsBox.querySelectorAll('input[type=checkbox]').forEach(cb => {
        cb.value = cb.closest('.p-card').querySelector('.p-name').textContent.trim();
        cb.addEventListener('change', updateSelectionUI);
      });
      updateSelectionUI();
    }

    async function fetchMatchNos(){
      try{
        const res = await fetch(`${API}?action=matchnos`);
        const j = await res.json();
        const opts = ['<option value="">— Select Match —</option>']
          .concat((j.matchNos||[]).map(n => `<option value="${n}">Match ${n}</option>`));
        matchNoSel.innerHTML = opts.join('');
        M.FormSelect.init(matchNoSel);
      }catch(e){
        matchNoSel.innerHTML = '<option value="">(failed)</option>';
        M.FormSelect.init(matchNoSel);
      }
    }

    async function fetchPlayers(){
      teamsBox.textContent = 'Loading players…';
      selCount.textContent = '0';
      try{
        const matchNo = matchNoSel.value;
        if (!matchNo){ teamsBox.textContent = 'Pick a match first.'; return; }
        const res = await fetch(`${API}?action=players&matchNo=${encodeURIComponent(matchNo)}`);
        const j = await res.json();
        if (!j.ok){ teamsBox.innerHTML = `<span class="red-text">${j.error||'API error'}</span>`; return; }
        renderPlayersByTeams(j.players||[]);
      }catch(err){
        teamsBox.innerHTML = '<span class="red-text">Network error</span>';
      }
    }

    async function loadLeaderboard(){
      lbTable.innerHTML = '<tr><td colspan="4">Loading…</td></tr>';
      try{
        const res = await fetch(`${API}?action=leaderboard`);
        const j = await res.json();
        if (!j.ok){ lbTable.innerHTML = `<tr><td colspan="4" class="red-text">${j.error||'API error'}</td></tr>`; return; }
        lbTable.innerHTML = (j.leaderboard||[]).map((r,i)=>`
          <tr>
            <td>${i+1}</td>
            <td>${r.name||''}</td>
            <td>${r.email}</td>
            <td><span class="new badge green" data-badge-caption="">${r.total}</span></td>
          </tr>`).join('') || '<tr><td colspan="4" class="grey-text">No data yet.</td></tr>';
      }catch(e){
        lbTable.innerHTML = '<tr><td colspan="4" class="red-text">Failed</td></tr>';
      }
    }

    // Submit by matchNo
    async function submitTeam(){
      const email = (emailEl.value||'').trim();
      const matchNo = matchNoSel.value;
      const players = selectedPlayers();
      if (!email || !matchNo){ notify('Email & Match No required'); return; }
      if (players.length !== 11){ notify('Pick exactly 11 players'); return; }

      submitBtn.classList.add('disabled');
      try{
        const qs = new URLSearchParams({ action:'submitteam', email, matchNo, players: JSON.stringify(players) });
        const res = await fetch(`${API}?${qs.toString()}`, { method:'GET' });
        const j = await res.json();
        if (j.ok){
          notify('Submitted! Refresh leaderboard.');
          teamsBox.querySelectorAll('input[type=checkbox]').forEach(c => c.checked=false);
          updateSelectionUI();
        } else {
          notify(j.error || 'Submission failed');
        }
      }catch(e){
        notify('Network error while submitting');
      }finally{
        submitBtn.classList.remove('disabled');
      }
    }

    // ---- Admin (matchNo-based) ----
    async function adminSetPoints(){
      const adminToken = adminTokenEl.value;
      const matchNo = Number(adminMatchNoEl.value || matchNoSel.value);
      const points = Number(adminPointsEl.value);
      const playerName = adminPlayerEl.value;
      if (!adminToken || !playerName || !matchNo){ notify('Token, player & matchNo required'); return; }
      try{
        const qs = new URLSearchParams({ action:'setpoints', adminToken, playerName, matchNo:String(matchNo), points:String(points) });
        const res = await fetch(`${API}?${qs.toString()}`, { method:'GET' });
        const j = await res.json();
        if (j.ok) notify(`Points updated (rows: ${j.updated||0})`);
        else notify(j.error || 'Update failed');
      }catch(e){ notify('Network error while updating points'); }
    }

    // ---- MY TEAMS (compare with images) ----
    const email2El = document.getElementById('email2');
    const limitEl = document.getElementById('limit');
    const loadBtn = document.getElementById('loadBtn');
    const leftMeta = document.getElementById('leftMeta');
    const rightMeta = document.getElementById('rightMeta');
    const overlapMeta = document.getElementById('overlapMeta');
    const leftPlayersBox = document.getElementById('leftPlayers');
    const rightPlayersBox = document.getElementById('rightPlayers');
    const compareSelect = document.getElementById('compareSelect');
    const listBody = document.getElementById('listBody');

    let latestTeam = null; let allTeams = [];

    function chip(player, imgSrc, cls){
      const imgTag = imgSrc ? `<img src="${imgSrc}" alt="${player}">` : '';
      return `<span classplayer}</span>`;
    }
    function overlapCount(a,b){ const s=new Set(a||[]); return (b||[]).reduce((acc,x)=>acc+(s.has(x)?1:0),0); }
    function setTeamMeta(el, team){ el.textContent = team ? `Match: ${team.matchNo} • Points: ${team.points} • ID: ${team.entryId}` : '—'; }

    async function getImageMapForMatch(matchNo){
      const map = new Map();
      try{
        const res = await fetch(`${API}?action=players&matchNo=${encodeURIComponent(matchNo)}`);
        const j = await res.json();
        if (j.ok){ (j.players||[]).forEach(p => map.set(p.name, p.image||'')); }
      }catch(_){}
      return map;
    }

    function buildCompareOptions(teams){
      const opts = ['<option value="">-- Select --</option>'];
      teams.slice(1).forEach(t => opts.push(`<option value="${t.entryId}">Match ${t.matchNo} (Pts ${t.points})</option>`));
      compareSelect.innerHTML = opts.join('');
      M.FormSelect.init(compareSelect);
    }
    function renderList(teams){
      if(!teams.length){ listBody.innerHTML='<tr><td colspan="5">No submissions yet.</td></tr>'; return; }
      listBody.innerHTML = teams.map((t,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${t.matchNo}</td>
          <td>${t.points}</td>
          <td class="grey-text text-darken-1">${t.entryId}</td>
          <td><a class="btn-flat waves-effect" onclick="selectRight('${t.entryId}')"><i class="material-icons left">compare</i>Compare</a></td>
        </tr>`).join('');
    }

    async function selectRight(entryId){
      const t = allTeams.find(x => x.entryId === entryId);
      if(!t) return;

      const leftMap  = await getImageMapForMatch(latestTeam ? latestTeam.matchNo : t.matchNo);
      const rightMap = await getImageMapForMatch(t.matchNo);
      const mergedMap = new Map([...leftMap, ...rightMap]);

      const leftSet = new Set(latestTeam ? latestTeam.players : []);
      setTeamMeta(rightMeta, t);
      const o = overlapCount(latestTeam ? latestTeam.players : [], t.players||[]);
      overlapMeta.textContent = `Common: ${o} / 11`;
      renderTeamPlayers(rightPlayersBox, t.players||[], leftSet, 'right', mergedMap);

      compareSelect.value = entryId;
      M.FormSelect.init(compareSelect);
    }

    function renderTeamPlayers(container, players, compareSet, side, imageMap){
      container.innerHTML='';
      const ownSet = new Set(players||[]);
      const onlyOwn = [...ownSet].filter(p => !compareSet.has(p));
      const common  = [...ownSet].filter(p => compareSet.has(p));

      common.forEach(p => container.insertAdjacentHTML('beforeend', chip(p, imageMap.get(p)||'', 'chip-common')));
      if (side==='left'){
        onlyOwn.forEach(p => container.insertAdjacentHTML('beforeend', chip(p, imageMap.get(p)||'', 'chip-left-only')));
      } else {
        onlyOwn.forEach(p => container.insertAdjacentHTML('beforeend', chip(p, imageMap.get(p)||'', 'chip-right-only')));
      }
    }

    async function loadMyTeams(){
      const email=(email2El.value||'').trim().toLowerCase();
      if(!email){ notify('Please enter your email'); return; }
      localStorage.setItem('ml_email', email);
      const limit=Number(limitEl.value||20);

      try{
        const res = await fetch(`${API}?action=myteams&email=${encodeURIComponent(email)}&limit=${encodeURIComponent(limit)}`);
        const j = await res.json();
        if(!j.ok){ notify(j.error||'API error'); return; }

        latestTeam=j.latest||null;
        allTeams=Array.isArray(j.items)?j.items:[];
        if(!latestTeam){
          leftMeta.textContent='No submissions yet.'; leftPlayersBox.innerHTML='';
          rightMeta.textContent='—'; rightPlayersBox.innerHTML=''; overlapMeta.textContent='—';
          compareSelect.innerHTML=''; M.FormSelect.init(compareSelect); renderList([]); return;
        }

        const imgMap = await getImageMapForMatch(latestTeam.matchNo);
        setTeamMeta(leftMeta, latestTeam);
        renderTeamPlayers(leftPlayersBox, latestTeam.players||[], new Set(), 'left', imgMap);

        buildCompareOptions(allTeams);
        if(allTeams.length>1){ selectRight(allTeams[1].entryId); }
        else { rightMeta.textContent='No previous team to compare.'; rightPlayersBox.innerHTML=''; overlapMeta.textContent='—'; }
        renderList(allTeams);
      }catch(err){
        notify('Network error while loading teams');
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      M.AutoInit();
      const stored = (localStorage.getItem('ml_email')||'');
      if (stored){ emailEl.value = stored; document.getElementById('email2').value = stored; M.updateTextFields(); }
      activateView(location.hash || '#submit');

      document.addEventListener('input', (e)=>{
        if (e.target.id==='email'){ localStorage.setItem('ml_email', e.target.value||''); updateSelectionUI(); }
        if (e.target.id==='email2'){ localStorage.setItem('ml_email', e.target.value||''); }
      });

      matchNoSel.addEventListener('change', fetchPlayers);
      document.getElementById('submitBtn').addEventListener('click', submitTeam);
      document.getElementById('refreshPlayers').addEventListener('click', fetchPlayers);
      document.getElementById('refreshLb').addEventListener('click', loadLeaderboard);
      document.getElementById('adminSetPoints').addEventListener('click', adminSetPoints);
      document.getElementById('loadBtn').addEventListener('click', loadMyTeams);

      fetchMatchNos().then(fetchPlayers);
      loadLeaderboard();
    });

    window.selectRight = selectRight; // expose for table action
  </script>
</body>
</html>
