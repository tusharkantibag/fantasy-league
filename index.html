<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sports Fever IPL Fantasy 2026</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<style>
    body { background:#f5f7fb; }
    nav .brand-logo { font-weight:800; }

    /* Larger player images */
    .avatar {
        width: 60px !important;
        height: 60px !important;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #e0e0e0;
        background: #fafafa;
    }

    .chip-player {
        display: flex;
        align-items: center;
        gap: .7rem;
        padding: .6rem .8rem;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
    }

    /* Two column layout */
    .team-col {
        display: flex;
        flex-direction: column;
        gap: .7rem;
    }

    .sticky-actions {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding: .75rem;
        border-top: 1px solid #eee;
        display: flex;
        gap: .5rem;
        justify-content: flex-end;
    }

    .sticky-head { 
        position: sticky;
        top:0;
        background:white;
        z-index:2;
        border-bottom:1px solid #eee;
    }

</style>
</head>

<body>

<nav class="blue">
    <div class="nav-wrapper container">
        <a href="#submit" class="brand-logo"><i class="material-icons">emoji_events</i> Sports Fever IPL Fantasy 2026</a>
        <ul class="right">
            <li><a href="#submit"><i class="material-icons left">send</i>Submit</a></li>
            <li><a href="#my-teams"><i class="material-icons left">view_week</i>My Teams</a></li>
        </ul>
    </div>
</nav>

<main class="container" style="margin-top:1.25rem;">
<section id="submit" class="view active">

<div class="row">
<div class="col l7 s12">
<div class="card">
<div class="card-content">

<span class="card-title">Submit Team  
    <span class="new badge blue" id="selCount" data-badge-caption="/11 selected">0</span>
</span>

<div class="row">
    <div class="input-field col s12 m6">
        <input id="email" type="email" class="validate" placeholder="you@example.com">
        <label class="active" for="email">Your Email</label>
    </div>

    <div class="input-field col s12 m6">
        <select id="matchSelect"></select>
        <label>Match</label>
    </div>
</div>

<!-- REPLACED OLD PLAYER GRID WITH TWO TEAM COLUMNS -->
<label>Player Pool (for selected match)</label>

<div class="row" style="margin-top:1rem;">
    <div class="col s12 m6">
        <h6><b>Team IND</b></h6>
        <div id="playersIND" class="team-col"></div>
    </div>

    <div class="col s12 m6">
        <h6><b>Team AUS</b></h6>
        <div id="playersAUS" class="team-col"></div>
    </div>
</div>

<p class="grey-text">Select exactly 11 players.</p>

</div>

<div class="sticky-actions">
    <a id="refreshPlayers" class="btn-flat waves-effect"><i class="material-icons left">refresh</i>Reload</a>
    <a id="submitBtn" class="btn waves-effect waves-light blue disabled"><i class="material-icons left">send</i>Submit Team</a>
</div>

</div>
</div>
</div>

</section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>

// API ENDPOINT
const API =
  "https://script.google.com/macros/s/AKfycbz_M2B-WY4aASsTOwryQXSHHFDanFFLc9LsJuHSf1KlWtXDt9tPN-5cryUZAy8OjeUq/exec";

const playersIND = document.getElementById("playersIND");
const playersAUS = document.getElementById("playersAUS");
const matchSelectEl = document.getElementById("matchSelect");
const emailEl = document.getElementById("email");
const selCount = document.getElementById("selCount");
const submitBtn = document.getElementById("submitBtn");
const refreshPlayersBtn = document.getElementById("refreshPlayers");

const playerImgMap = {};

function selectedPlayers() {
    return Array.from(
        document.querySelectorAll("input[type=checkbox]:checked")
    ).map(x => x.value);
}

function updateSelectionUI() {
    const n = selectedPlayers().length;
    selCount.textContent = n;

    if (!emailEl.value || !matchSelectEl.value || n !== 11) {
        submitBtn.classList.add("disabled");
    } else {
        submitBtn.classList.remove("disabled");
    }
}

/* ---------------------------
   RENDER PLAYERS IN TWO COLUMNS
---------------------------- */

function renderPlayers(list) {
    playersIND.innerHTML = "";
    playersAUS.innerHTML = "";

    list.forEach(p => {
        const label = document.createElement("label");
        label.className = "chip-player";

        const imgSrc =
            p.imageUrl || p.image || p.img || p.PlayerImageURL || p.photo || "";

        if (p.name && imgSrc) playerImgMap[p.name] = imgSrc;

        const imgTag = imgSrc
            ? `<img class="avatar" src="${imgSrc}" loading="lazy">`
            : `<i class="material-icons grey-text">person</i>`;

        label.innerHTML = `
            <label><input type="checkbox"/><span></span></label>
            ${imgTag}
            <span>${p.name} <span class="grey-text">(${p.team})</span></span>
        `;

        label.querySelector("input").value = p.name;

        // TEAM SPLIT
        if (p.team === "IND") playersIND.appendChild(label);
        else playersAUS.appendChild(label);
    });

    // Add listeners
    document
      .querySelectorAll("#playersIND input[type=checkbox], #playersAUS input[type=checkbox]")
      .forEach(cb => cb.addEventListener("change", updateSelectionUI));

    updateSelectionUI();
}

/* ---------------------------
   FETCH MATCHES
---------------------------- */
async function fetchMatches() {
    const res = await fetch(`${API}?action=matches`);
    const data = await res.json();

    const opts = ['<option value="">-- Select Match --</option>'];
    data.matches.forEach(m =>
        opts.push(`<option value="${m.id}">${m.label}</option>`)
    );

    matchSelectEl.innerHTML = opts.join("");
    M.FormSelect.init(matchSelectEl);

    if (data.matches.length) {
        matchSelectEl.value = String(data.matches[0].id);
        M.FormSelect.init(matchSelectEl);
        fetchPlayers();
    }
}

/* ---------------------------
   FETCH PLAYERS
---------------------------- */
async function fetchPlayers() {
    playersIND.innerHTML = "Loading...";
    playersAUS.innerHTML = "Loading...";

    const res = await fetch(
        `${API}?action=players&matchId=${matchSelectEl.value}`
    );
    const data = await res.json();

    renderPlayers(data.players || []);
}

/* ---------------------------
   SUBMIT TEAM
---------------------------- */
async function submitTeam() {
    const email = emailEl.value.trim();
    const players = selectedPlayers();

    if (!email || players.length !== 11) return;

    const qs = new URLSearchParams();
    qs.set("action", "submitteam");
    qs.set("email", email);
    qs.set("matchId", matchSelectEl.value);
    qs.set("players", JSON.stringify(players));

    await fetch(`${API}?${qs.toString()}`);
    M.toast({ html: "Team Submitted!" });
}

document.addEventListener("DOMContentLoaded", () => {
    M.AutoInit();

    fetchMatches();
    refreshPlayersBtn.addEventListener("click", fetchPlayers);
    submitBtn.addEventListener("click", submitTeam);
});

</script>

</body>
</html>
